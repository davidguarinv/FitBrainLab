{% extends "base.html" %}
{% block title %}Communities - Fit Brain Lab{% endblock %}
{% block content %}
    <main class="container mx-auto px-4 py-8">
        <!-- Hero Section -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900 mb-4">Find Your Community</h1>
            <p class="text-xl text-gray-600 max-w-3xl mx-auto">
                Discover the perfect fitness community in Amsterdam that matches your interests, schedule, and budget
            </p>
        </div>

        <!-- Controls Section -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex flex-wrap gap-4 items-center justify-between">
                <!-- Left side controls -->
                <div class="flex flex-wrap gap-3 items-center">
                    <!-- Map Toggle -->
                    <button id="mapToggle" class="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-map"></i>
                        <span>Show Map</span>
                    </button>

                    <!-- Search -->
                    <div class="relative">
                        <input 
                            type="text" 
                            id="searchInput" 
                            placeholder="Search communities..." 
                            class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent w-64"
                        >
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                </div>

                <!-- Right side filters -->
                <div class="flex flex-wrap gap-3 items-center">
                    <!-- Cost Filter -->
                    <select id="costFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">All Costs</option>
                        <option value="Free">Free</option>
                        <option value="Paid">Paid</option>
                        <option value="NA">Not Specified</option>
                    </select>

                    <!-- Student Filter -->
                    <select id="studentFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">All Groups</option>
                        <option value="Yes">Student-Based</option>
                        <option value="No">Open to All</option>
                    </select>

                    <!-- Sport Filter -->
                    <select id="sportFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">All Sports</option>
                    </select>

                    <!-- Clear Filters -->
                    <button id="clearFilters" class="text-gray-600 hover:text-gray-800 px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                        <i class="fas fa-times"></i> Clear
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="flex gap-6">
            <!-- Map Section -->
            <div id="mapContainer" class="hidden bg-white rounded-lg shadow-sm overflow-hidden" style="width: 50%; height: 600px;">
                <div id="map" class="w-full h-full"></div>
            </div>

            <!-- Communities Grid -->
            <div id="communitiesContainer" class="w-full">
                <div id="communitiesGrid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                    <!-- Communities will be dynamically loaded here -->
                </div>
                
                <!-- Loading State -->
                <div id="loadingState" class="text-center py-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                    <p class="text-gray-600">Loading communities...</p>
                </div>

                <!-- No Results State -->
                <div id="noResults" class="text-center py-12 hidden">
                    <i class="fas fa-search text-4xl text-gray-400 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-700 mb-2">No communities found</h3>
                    <p class="text-gray-600">Try adjusting your filters or search terms</p>
                </div>
            </div>
        </div>
    </main>

    <script>
        let communities = [];
        let filteredCommunities = [];
        let map = null;
        let markers = [];
        let isMapVisible = false;

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            loadCommunities();
            setupEventListeners();
        });

        // Load communities from JSON
        async function loadCommunities() {
            try {
                const response = await fetch('/static/data/communities.json');
                communities = await response.json();
                filteredCommunities = [...communities];
                
                populateSportFilter();
                renderCommunities();
                hideLoadingState();
            } catch (error) {
                console.error('Error loading communities:', error);
                hideLoadingState();
                showNoResults();
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('mapToggle').addEventListener('click', toggleMap);
            document.getElementById('searchInput').addEventListener('input', debounce(handleSearch, 300));
            document.getElementById('costFilter').addEventListener('change', handleFilter);
            document.getElementById('studentFilter').addEventListener('change', handleFilter);
            document.getElementById('sportFilter').addEventListener('change', handleFilter);
            document.getElementById('clearFilters').addEventListener('click', clearFilters);
        }

        // Populate sport filter with unique sports
        function populateSportFilter() {
            const sports = new Set();
            communities.forEach(community => {
                if (community.Sport) {
                    community.Sport.split(',').forEach(sport => {
                        sports.add(sport.trim());
                    });
                }
            });

            const sportFilter = document.getElementById('sportFilter');
            sports.forEach(sport => {
                const option = document.createElement('option');
                option.value = sport;
                option.textContent = sport;
                sportFilter.appendChild(option);
            });
        }

        // Toggle map visibility
        function toggleMap() {
            const mapContainer = document.getElementById('mapContainer');
            const communitiesContainer = document.getElementById('communitiesContainer');
            const mapToggle = document.getElementById('mapToggle');
            const communitiesGrid = document.getElementById('communitiesGrid');

            isMapVisible = !isMapVisible;

            if (isMapVisible) {
                mapContainer.classList.remove('hidden');
                communitiesContainer.style.width = '50%';
                communitiesContainer.style.height = '600px';
                communitiesContainer.style.overflowY = 'auto';
                communitiesGrid.classList.remove('xl:grid-cols-3');
                communitiesGrid.classList.add('xl:grid-cols-1');
                mapToggle.innerHTML = '<i class="fas fa-list"></i><span>Hide Map</span>';
                mapToggle.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                mapToggle.classList.add('bg-gray-600', 'hover:bg-gray-700');
                
                if (!map) {
                    initializeMap();
                } else {
                    updateMapMarkers();
                }
            } else {
                mapContainer.classList.add('hidden');
                communitiesContainer.style.width = '100%';
                communitiesContainer.style.height = 'auto';
                communitiesContainer.style.overflowY = 'visible';
                communitiesGrid.classList.add('xl:grid-cols-3');
                communitiesGrid.classList.remove('xl:grid-cols-1');
                mapToggle.innerHTML = '<i class="fas fa-map"></i><span>Show Map</span>';
                mapToggle.classList.add('bg-blue-600', 'hover:bg-blue-700');
                mapToggle.classList.remove('bg-gray-600', 'hover:bg-gray-700');
            }
        }

        // Initialize Google Map
        function initializeMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 11,
                center: { lat: 52.3676, lng: 4.9041 }, // Amsterdam center
                styles: [
                    {
                        featureType: 'poi',
                        elementType: 'labels',
                        stylers: [{ visibility: 'off' }]
                    }
                ]
            });

            updateMapMarkers();
        }

        // Update map markers based on filtered communities
        function updateMapMarkers() {
            if (!map) return;

            // Clear existing markers
            markers.forEach(marker => marker.setMap(null));
            markers = [];

            // Add new markers
            filteredCommunities.forEach((community, index) => {
                if (community.Location) {
                    geocodeAddress(community.Location, community, index);
                }
            });
        }

        // Geocode address to coordinates
        function geocodeAddress(address, community, index) {
            const geocoder = new google.maps.Geocoder();
            geocoder.geocode({ address: address + ', Amsterdam, Netherlands' }, (results, status) => {
                if (status === 'OK') {
                    const marker = new google.maps.Marker({
                        position: results[0].geometry.location,
                        map: map,
                        title: community.Name,
                        icon: {
                            url: 'data:image/svg+xml;base64,' + btoa(`
                                <svg xmlns="http://www.w3.org/2000/svg" width="30" height="40" viewBox="0 0 30 40">
                                    <path fill="#2563eb" d="M15 0C6.7 0 0 6.7 0 15c0 8.3 15 25 15 25s15-16.7 15-25C30 6.7 23.3 0 15 0zm0 20c-2.8 0-5-2.2-5-5s2.2-5 5-5 5 2.2 5 5-2.2 5-5 5z"/>
                                </svg>
                            `),
                            scaledSize: new google.maps.Size(30, 40)
                        }
                    });

                    const infoWindow = new google.maps.InfoWindow({
                        content: `
                            <div class="p-2">
                                <h3 class="font-bold text-lg mb-2">${community.Name}</h3>
                                <p class="text-sm text-gray-600 mb-1"><strong>Sport:</strong> ${community.Sport}</p>
                                <p class="text-sm text-gray-600 mb-1"><strong>Location:</strong> ${community.Location}</p>
                                <p class="text-sm text-gray-600 mb-1"><strong>Cost:</strong> ${community.Cost}</p>
                                <p class="text-sm text-gray-600 mb-1"><strong>Student-based:</strong> ${community['Student-based']}</p>
                                ${community.website ? `<a href="${community.website}" target="_blank" class="text-blue-600 hover:underline text-sm">Visit Website</a>` : ''}
                            </div>
                        `
                    });

                    marker.addListener('click', () => {
                        infoWindow.open(map, marker);
                    });

                    markers.push(marker);
                }
            });
        }

        // Handle search
        function handleSearch(event) {
            const searchTerm = event.target.value.toLowerCase();
            applyFilters();
        }

        // Handle filter changes
        function handleFilter() {
            applyFilters();
        }

        // Apply all filters
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const costFilter = document.getElementById('costFilter').value;
            const studentFilter = document.getElementById('studentFilter').value;
            const sportFilter = document.getElementById('sportFilter').value;

            filteredCommunities = communities.filter(community => {
                // Search filter
                const matchesSearch = !searchTerm || 
                    community.Name.toLowerCase().includes(searchTerm) ||
                    community.Sport.toLowerCase().includes(searchTerm) ||
                    community.Location.toLowerCase().includes(searchTerm);

                // Cost filter
                const matchesCost = !costFilter || 
                    (costFilter === 'Free' && (community.Cost === 'Free' || community.Cost === '0')) ||
                    (costFilter === 'Paid' && community.Cost !== 'Free' && community.Cost !== '0' && community.Cost !== 'NA') ||
                    (costFilter === 'NA' && community.Cost === 'NA');

                // Student filter
                const matchesStudent = !studentFilter || community['Student-based'] === studentFilter;

                // Sport filter
                const matchesSport = !sportFilter || community.Sport.includes(sportFilter);

                return matchesSearch && matchesCost && matchesStudent && matchesSport;
            });

            renderCommunities();
            if (isMapVisible) {
                updateMapMarkers();
            }
        }

        // Clear all filters
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('costFilter').value = '';
            document.getElementById('studentFilter').value = '';
            document.getElementById('sportFilter').value = '';
            filteredCommunities = [...communities];
            renderCommunities();
            if (isMapVisible) {
                updateMapMarkers();
            }
        }

        // Render communities
        function renderCommunities() {
            const grid = document.getElementById('communitiesGrid');
            const noResults = document.getElementById('noResults');

            if (filteredCommunities.length === 0) {
                grid.innerHTML = '';
                noResults.classList.remove('hidden');
                return;
            }

            noResults.classList.add('hidden');
            
            grid.innerHTML = filteredCommunities.map(community => `
                <div class="bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow duration-200 overflow-hidden">
                    <div class="aspect-w-16 aspect-h-9 bg-gray-200">
                        <img 
                            src="${community.image_url || '/static/images/default-community.jpg'}" 
                            alt="${community.Name}"
                            class="w-full h-48 object-cover"
                            onerror="this.src='/static/images/default-community.jpg'"
                        >
                    </div>
                    <div class="p-6">
                        <h3 class="text-xl font-semibold text-gray-900 mb-2">${community.Name}</h3>
                        <div class="space-y-2 text-sm text-gray-600 mb-4">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-dumbbell text-blue-600 w-4"></i>
                                <span>${community.Sport}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fas fa-map-marker-alt text-blue-600 w-4"></i>
                                <span>${community.Location}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fas fa-dollar-sign text-blue-600 w-4"></i>
                                <span>${community.Cost === 'NA' ? 'Contact for pricing' : community.Cost}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fas fa-users text-blue-600 w-4"></i>
                                <span>${community['Student-based'] === 'Yes' ? 'Student-focused' : 'Open to all'}</span>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            ${community.website ? `
                                <a href="${community.website}" target="_blank" class="flex-1 bg-blue-600 text-white text-center py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium">
                                    Visit Website
                                </a>
                            ` : ''}
                            ${community.email ? `
                                <a href="mailto:${community.email}" class="flex-1 bg-gray-600 text-white text-center py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors text-sm font-medium">
                                    Contact
                                </a>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Hide loading state
        function hideLoadingState() {
            document.getElementById('loadingState').style.display = 'none';
        }

        // Show no results
        function showNoResults() {
            document.getElementById('noResults').classList.remove('hidden');
        }

        // Debounce function for search
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    </script>

    <!-- Google Maps API -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&callback=initializeMap"></script>

{% endblock %}

