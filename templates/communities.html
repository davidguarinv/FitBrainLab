{% extends "base.html" %}
{% block title %}Communities - Fit Brain Lab{% endblock %}
{% block content %}
<main class="flex-1 min-h-screen bg-gradient-to-br from-slate-50 to-orange-50">

    <section class="relative w-full py-12 md:py-24 lg:py-32 overflow-hidden">
        <!-- Animated Background -->
        <div class="absolute inset-0 bg-gradient-to-br from-orange-900 via-red-900 to-pink-900">
          <!-- Floating Elements -->
          <div class="absolute top-20 left-10 w-16 h-16 border-2 border-orange-300/30 rounded-lg rotate-12 animate-pulse"></div>
          <div class="absolute top-40 right-20 w-12 h-12 border-2 border-red-300/30 rounded-full animate-bounce"></div>
          <div class="absolute bottom-32 left-1/4 w-20 h-20 border-2 border-pink-300/30 rounded-lg -rotate-12 animate-pulse"></div>
          <div class="absolute top-1/3 right-1/3 w-8 h-8 bg-orange-400/20 rounded-full animate-ping"></div>
          <div class="absolute bottom-20 right-10 w-14 h-14 border-2 border-red-400/30 rounded-lg rotate-45 animate-pulse"></div>
        </div>

        <div class="relative container mx-auto px-4 md:px-6">
          <div class="flex flex-col items-center text-center space-y-4 mb-8">
            <div class="space-y-2">
              <div class="inline-block rounded-lg bg-orange-100/90 backdrop-blur px-3 py-1 text-sm text-orange-700 font-medium mb-2">
                Community Network
              </div>
              <h1 class="text-3xl font-bold tracking-tighter sm:text-4xl md:text-5xl text-white">
                Find Your Fitness Community
              </h1>
              <p class="max-w-[800px] text-orange-100 md:text-xl">
                Discover the perfect fitness community in Amsterdam that matches your interests, schedule, and goals.
                Connect with like-minded individuals and build lasting exercise habits together.
              </p>
            </div>
          </div>
        </div>
    </section>

    <section class="container mx-auto px-4 md:px-6 py-8 md:py-12">
        <div class="mb-8 p-6 bg-gradient-to-r from-orange-50 to-red-50 rounded-xl border border-orange-100/50 shadow-lg backdrop-blur">
            <div class="flex flex-col md:flex-row gap-6 items-start md:items-end">
                <button id="mapToggle" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-white transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-orange-400 focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-orange-300 bg-white hover:bg-orange-100 hover:text-orange-600 h-10 px-4 py-2 gap-2 text-orange-700 w-full md:w-auto mt-4 md:mt-0 md:self-end">
                    <!-- Content dynamically set by JS -->
                </button>
                <div class="flex-1 space-y-2">
                    
                    <label htmlFor="searchInput" class="text-sm font-medium">
                        Search Communities
                    </label>
                    <div class="relative">
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="24"
                            height="24"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            class="absolute left-2.5 top-2.5 h-4 w-4 text-gray-500"
                        >
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.3-4.3"></path>
                        </svg>
                        <input
                            id="searchInput"
                            type="text"
                            placeholder="Search by name, sport, or location..."
                            class="flex h-10 w-full rounded-md border border-orange-200 bg-white px-3 py-2 text-sm ring-offset-white file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-gray-500 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-orange-400 focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 pl-8"
                        />
                    </div>
                </div>

                <div class="w-full md:w-[180px] space-y-2">
                    <label class="text-sm font-medium">Cost</label>
                    <select
                        id="costFilter"
                        class="flex h-10 w-full rounded-md border border-orange-200 bg-white px-3 py-2 text-sm ring-offset-white focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-orange-400 focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
                    >
                        <option value="all">All Costs</option>
                        <option value="Free">Free</option>
                        <option value="Paid">Paid</option>
                        <option value="NA">Contact for pricing</option>
                    </select>
                </div>

                <div class="w-full md:w-[200px] space-y-2">
                    <label class="text-sm font-medium">Student Focus</label>
                    <select
                        id="studentFilter"
                        class="flex h-10 w-full rounded-md border border-orange-200 bg-white px-3 py-2 text-sm ring-offset-white focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-orange-400 focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
                    >
                        <option value="all">All Groups</option>
                        <option value="Yes">Student-Based</option>
                        <option value="No">Open to All</option>
                    </select>
                </div>

                <div class="w-full md:w-[180px] space-y-2">
                    <label class="text-sm font-medium">Sport</label>
                    <select
                        id="sportFilter"
                        class="flex h-10 w-full rounded-md border border-orange-200 bg-white px-3 py-2 text-sm ring-offset-white focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-orange-400 focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
                    >
                        <option value="all">All Sports</option>
                        <!-- Options populated by JS -->
                    </select>
                </div>

                

                <button id="clearFilters" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-white transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-orange-400 focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-orange-300 bg-white hover:bg-orange-100 hover:text-orange-600 h-10 px-4 py-2 gap-2 text-orange-700 w-full md:w-auto">
                    <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="h-4 w-4"
                    >
                    <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                    </svg>
                    <span>Reset Filters</span>
                </button>
            </div>
        </div>
    </section>

    <section class="relative w-full pb-12 md:pb-24">
      <div class="absolute inset-0 bg-[radial-gradient(circle_at_1px_1px,rgba(251,146,60,0.05)_1px,transparent_0)] bg-[size:20px_20px] pointer-events-none"></div>
      <div class="relative container mx-auto px-4 md:px-6">
        <div class="flex flex-col lg:flex-row gap-6">
            <div id="mapContainer" class="hidden lg:w-1/2 bg-white rounded-lg shadow-sm overflow-hidden" style="height: 600px;">
                <div id="map" class="w-full h-full bg-gradient-to-br from-orange-100 to-red-100 flex items-center justify-center">
                    <!-- Map Placeholder Content if map doesn't load, or before it loads -->
                     <div class="text-center text-orange-700">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" class="h-16 w-16 mx-auto mb-4">
                            <polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21"></polygon>
                            <line x1="9" x2="9" y1="3" y2="18"></line>
                            <line x1="15" x2="15" y1="6" y2="21"></line>
                        </svg>
                        <p class="text-lg font-semibold">Interactive Map</p>
                        <p class="text-sm">Community locations will appear here</p>
                    </div>
                </div>
            </div>

            <div id="communitiesWrapper" class="w-full"> <!-- lg:w-1/2 dynamically by JS -->
                <div class="mb-6 flex justify-between items-center">
                    <h2 id="communitiesCount" class="text-xl font-bold text-slate-800">Communities (0)</h2>
                </div>
                <div id="communitiesContainer" class="w-full"> <!-- Height and scroll handled by JS -->
                    <div id="communitiesGrid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                        <!-- Communities will be rendered here by JS -->
                    </div>

                    <div id="loadingState" class="text-center py-12 hidden">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-orange-600 mx-auto mb-4"></div>
                        <p class="text-gray-600">Loading communities...</p>
                    </div>

                    <div id="noResults" class="text-center py-12 hidden">
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="24"
                            height="24"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            strokeWidth="2"
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            class="h-12 w-12 text-gray-400 mx-auto mb-4"
                        >
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.3-4.3"></path>
                        </svg>
                        <h3 class="text-xl font-semibold text-gray-700 mb-2">No communities found</h3>
                        <p class="text-gray-600">Try adjusting your filters or search terms</p>
                    </div>
                </div>
            </div>
        </div>
      </div>
    </section>

    <section class="w-full py-16 bg-gradient-to-br from-orange-900 via-red-900 to-pink-900">
        <div class="container mx-auto px-4 md:px-6 max-w-2xl">
            <div class="bg-white/10 backdrop-blur rounded-xl shadow-lg p-8 border border-orange-300/30">
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-bold mb-4 text-white">Add Your Community</h2>
                    <p class="text-orange-100">Help us grow our community directory by adding your sports group or club.</p>
                </div>

                {% if suggestion_sent %}
                    <div class="bg-green-100 border border-green-200 text-green-700 px-4 py-3 rounded-lg relative mb-6 text-center" role="alert">
                        <strong class="font-bold">Thank you!</strong>
                        <span class="block sm:inline"> Your suggestion was sent.</span>
                    </div>
                {% endif %}

                <form method="POST" action="{{ url_for('main.submit_community') }}" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-orange-100 mb-1">Community Name</label>
                            <input type="text" name="Name" placeholder="e.g., Amsterdam Running Club"
                                class="flex h-10 w-full rounded-md border border-orange-200/50 bg-white/20 px-3 py-2 text-sm text-white placeholder-orange-100/70 ring-offset-orange-900 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-orange-400 focus-visible:ring-offset-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-orange-100 mb-1">Contact Email</label>
                            <input type="email" name="email" placeholder="contact@example.com"
                                class="flex h-10 w-full rounded-md border border-orange-200/50 bg-white/20 px-3 py-2 text-sm text-white placeholder-orange-100/70 ring-offset-orange-900 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-orange-400 focus-visible:ring-offset-2">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-orange-100 mb-1">Address</label>
                            <input type="text" name="Address" placeholder="e.g., Science Park 904, Amsterdam"
                                class="flex h-10 w-full rounded-md border border-orange-200/50 bg-white/20 px-3 py-2 text-sm text-white placeholder-orange-100/70 ring-offset-orange-900 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-orange-400 focus-visible:ring-offset-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-orange-100 mb-1">Sport</label>
                            <input type="text" name="Sport" placeholder="e.g., Running, Football"
                                class="flex h-10 w-full rounded-md border border-orange-200/50 bg-white/20 px-3 py-2 text-sm text-white placeholder-orange-100/70 ring-offset-orange-900 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-orange-400 focus-visible:ring-offset-2">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-orange-100 mb-1">Website URL</label>
                            <input type="url" name="website" placeholder="https://yourclub.com"
                                class="flex h-10 w-full rounded-md border border-orange-200/50 bg-white/20 px-3 py-2 text-sm text-white placeholder-orange-100/70 ring-offset-orange-900 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-orange-400 focus-visible:ring-offset-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-orange-100 mb-1">Logo URL (Optional)</label>
                            <input type="url" name="image_url" placeholder="https://yourclub.com/logo.png"
                                class="flex h-10 w-full rounded-md border border-orange-200/50 bg-white/20 px-3 py-2 text-sm text-white placeholder-orange-100/70 ring-offset-orange-900 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-orange-400 focus-visible:ring-offset-2">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-orange-100 mb-1">Cost</label>
                             <input type="text" name="Cost" placeholder="Free, Paid, or NA"
                                class="flex h-10 w-full rounded-md border border-orange-200/50 bg-white/20 px-3 py-2 text-sm text-white placeholder-orange-100/70 ring-offset-orange-900 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-orange-400 focus-visible:ring-offset-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-orange-100 mb-1">Student-based?</label>
                            <select name="Student-based" class="flex h-10 w-full rounded-md border border-orange-200/50 bg-white/20 px-3 py-2 text-sm text-white ring-offset-orange-900 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-orange-400 focus-visible:ring-offset-2 child:text-gray-800">
                                <option value="" class="text-gray-500">Select...</option>
                                <option value="Yes">Yes</option>
                                <option value="No">No</option>
                            </select>
                        </div>
                    </div>


                    <div>
                        <label class="block text-sm font-medium text-orange-100 mb-1">Additional Information</label>
                        <textarea name="message" placeholder="Tell us about your community..." rows="4"
                            class="flex w-full rounded-md border border-orange-200/50 bg-white/20 px-3 py-2 text-sm text-white placeholder-orange-100/70 ring-offset-orange-900 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-orange-400 focus-visible:ring-offset-2"></textarea>
                    </div>

                    <div class="text-center">
                        <button type="submit" class="inline-flex items-center justify-center rounded-full text-lg font-semibold bg-orange-500 hover:bg-orange-600 text-white h-12 px-8 py-3 transition-colors w-full md:w-auto">
                            Submit Community
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </section>
</main>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<script>
// Load configuration
const config = {
    OPENCAGE_API_KEY: '48bcf64904a14f418e6920d63a9945a8' // Replace with your actual key if different
};

let communities = [];
let filteredCommunities = [];
let map = null;
let markerClusterGroup = null;
let isMapVisible = false;

// SVGs for map toggle button
const svgShowMap = `
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4">
  <polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21"></polygon>
  <line x1="9" x2="9" y1="3" y2="18"></line>
  <line x1="15" x2="15" y1="6" y2="21"></line>
</svg>
<span>Show Map</span>`;

const svgHideMap = `
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4">
  <line x1="8" x2="21" y1="6" y2="6"></line>
  <line x1="8" x2="21" y1="12" y2="12"></line>
  <line x1="8" x2="21" y1="18" y2="18"></line>
  <line x1="3" x2="3.01" y1="6" y2="6"></line>
  <line x1="3" x2="3.01" y1="12" y2="12"></line>
  <line x1="3" x2="3.01" y1="18" y2="18"></line>
</svg>
<span>Hide Map</span>`;

// Helper functions from tsx for styling consistency
const getCostBadgeColor = (cost) => {
    switch (String(cost)) {
      case "Free":
      case "0":
        return "bg-green-100 text-green-700 border-green-200";
      case "Paid": // This will catch any non-Free, non-NA string
        return "bg-orange-100 text-orange-700 border-orange-200";
      case "NA":
      default: // Handles undefined, null, or other unexpected values as "NA" for badge
        return "bg-gray-100 text-gray-700 border-gray-200";
    }
};

const getCostDisplayText = (cost) => {
    const costStr = String(cost);
    if (costStr === "NA" || costStr === "null" || costStr === "undefined") return "Contact for pricing";
    if (costStr === "Free" || costStr === "0") return "Free";
    return costStr; // For "Paid" or specific prices
};


document.addEventListener('DOMContentLoaded', function() {
    loadCommunities();
    setupEventListeners();
    adjustLayoutForMap(); // Initial layout adjustment
});

async function loadCommunities() {
    showLoadingState();
    try {
        const response = await fetch('/static/data/communities.json');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        communities = await response.json();
        filteredCommunities = [...communities];
        
        populateSportFilter();
        renderCommunities(); // This will also update the count
    } catch (error) {
        console.error('Error loading communities:', error);
        showNoResults();
        document.getElementById('communitiesCount').textContent = 'Communities (0)';
    } finally {
        hideLoadingState();
    }
}

function setupEventListeners() {
    document.getElementById('mapToggle').addEventListener('click', toggleMap);
    document.getElementById('searchInput').addEventListener('input', debounce(handleSearch, 300));
    document.getElementById('costFilter').addEventListener('change', handleFilter);
    document.getElementById('studentFilter').addEventListener('change', handleFilter);
    document.getElementById('sportFilter').addEventListener('change', handleFilter);
    document.getElementById('clearFilters').addEventListener('click', clearFilters);
}

function populateSportFilter() {
    const sports = new Set();
    communities.forEach(community => {
        if (community.Sport) {
            community.Sport.split(',').forEach(sport => {
                sports.add(sport.trim());
            });
        }
    });

    const sportFilterEl = document.getElementById('sportFilter');
    // Clear existing options except the first one ("All Sports")
    Array.from(sportFilterEl.options).slice(1).forEach(option => sportFilterEl.remove(option.index));
    
    Array.from(sports).sort().forEach(sport => {
        const option = document.createElement('option');
        option.value = sport;
        option.textContent = sport;
        sportFilterEl.appendChild(option);
    });
}

function adjustLayoutForMap() {
    const mapContainer = document.getElementById('mapContainer');
    const communitiesWrapper = document.getElementById('communitiesWrapper');
    const communitiesContainer = document.getElementById('communitiesContainer');
    const communitiesGrid = document.getElementById('communitiesGrid');
    const mapToggle = document.getElementById('mapToggle');

    if (isMapVisible) {
        mapContainer.classList.remove('hidden');
        mapContainer.classList.add('lg:w-1/2');
        communitiesWrapper.classList.remove('lg:w-full'); // Explicitly remove if it was set
        communitiesWrapper.classList.add('lg:w-1/2');
        
        communitiesContainer.style.height = '600px'; // Match map height
        communitiesContainer.style.overflowY = 'auto';
        communitiesContainer.classList.add('custom-scrollbar'); // Ensure this class is defined in your CSS if needed

        communitiesGrid.classList.remove('md:grid-cols-2', 'xl:grid-cols-3');
        communitiesGrid.classList.add('grid-cols-1'); // Simpler, always single column if map visible
        communitiesGrid.classList.add('md:grid-cols-1', 'xl:grid-cols-1');


        mapToggle.innerHTML = svgHideMap;
        // tsx styles for "Hide map": border border-orange-300 bg-white hover:bg-orange-100 hover:text-orange-600 text-orange-700
        // Keep existing classes and let the initial setup define the look:
        // mapToggle.classList.remove('bg-blue-600', 'hover:bg-blue-700');
        // mapToggle.classList.add('bg-gray-600', 'hover:bg-gray-700'); // Example of alternative style
        
        if (!map) {
            initializeMap();
        } else {
            map.invalidateSize();
            updateMapMarkers();
        }
    } else {
        mapContainer.classList.add('hidden');
        mapContainer.classList.remove('lg:w-1/2');
        communitiesWrapper.classList.remove('lg:w-1/2');
        communitiesWrapper.classList.add('lg:w-full'); // Ensure it takes full width when map is hidden

        communitiesContainer.style.height = 'auto';
        communitiesContainer.style.overflowY = 'visible';
        communitiesContainer.classList.remove('custom-scrollbar');

        communitiesGrid.classList.remove('grid-cols-1', 'md:grid-cols-1', 'xl:grid-cols-1');
        communitiesGrid.classList.add('md:grid-cols-2', 'xl:grid-cols-3');

        mapToggle.innerHTML = svgShowMap;
        // tsx styles for "Show map": border border-orange-300 bg-white hover:bg-orange-100 hover:text-orange-600 text-orange-700
        // mapToggle.classList.remove('bg-gray-600', 'hover:bg-gray-700');
        // mapToggle.classList.add('bg-blue-600', 'hover:bg-blue-700'); // Example
    }
    renderCommunities(); // Re-render to apply size-dependent classes in cards if any
}

function toggleMap() {
    isMapVisible = !isMapVisible;
    adjustLayoutForMap();
}

function initializeMap() {
    try {
        map = L.map('map').setView([52.3676, 4.9041], 11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors'
        }).addTo(map);
        markerClusterGroup = L.markerClusterGroup();
        map.addLayer(markerClusterGroup);
        updateMapMarkers();
        map.invalidateSize();
    } catch (error) {
        console.error('Error initializing map:', error);
        const mapToggle = document.getElementById('mapToggle');
        mapToggle.disabled = true;
        mapToggle.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4 text-red-500"><path d="m21.73 18.73-5-5L8 18l-6-6 6-6 1.27 1.27"></path><path d="M12 18러스터 그룹에 추가합니다.다리 사이"></path></svg><span>Map Error</span>`;
        // Show the placeholder in the map div again if init fails
        document.getElementById('map').innerHTML = `
            <div class="w-full h-full bg-gradient-to-br from-orange-100 to-red-100 flex items-center justify-center">
              <div class="text-center text-orange-700">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-16 w-16 mx-auto mb-4"><polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21"></polygon><line x1="9" x2="9" y1="3" y2="18"></line><line x1="15" x2="15" y1="6" y2="21"></line></svg>
                <p class="text-lg font-semibold">Map Currently Unavailable</p>
                <p class="text-sm text-red-600">There was an issue loading the map.</p>
              </div>
            </div>`;
    }
}

function updateMapMarkers() {
    if (!map || !markerClusterGroup) return;
    try {
        markerClusterGroup.clearLayers();
        filteredCommunities.forEach(community => {
            if (community.Location && community.Name) {
                geocodeAddress(community.Location, community);
            }
        });
    } catch (error) {
        console.error('Error updating map markers:', error);
    }
}

async function geocodeAddress(address, community) {
    const apiKey = config.OPENCAGE_API_KEY;
    if (!apiKey || apiKey === 'YOUR_OPENCAGE_API_KEY' || apiKey === '48bcf64904a14f418e6920d63a9945a8') { // Added the example key here
        console.warn("OpenCage API key is a sample or not configured. Geocoding might be limited or fail. Address:", address);
        // Do not attempt to geocode if using the placeholder key publicly or if it's missing.
        // You might want to add a visual indicator on the map or card that location is approximate or unavailable.
        if (apiKey === '48bcf64904a14f418e6920d63a9945a8') return; // Don't proceed with the example key for actual calls
    }

    try {
        const response = await fetch(`https://api.opencagedata.com/geocode/v1/json?q=${encodeURIComponent(address)}&key=${apiKey}&pretty=1&limit=1&countrycode=NL&bounds=4.7271_52.2780_5.0791_52.4311`);
        const data = await response.json();
        if (data.results && data.results.length > 0) {
            const { lat, lng } = data.results[0].geometry;
            const marker = L.marker([lat, lng], {
                title: community.Name,
                icon: L.icon({
                    iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
                    iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34]
                })
            });
            marker.bindPopup(`
                <div class="p-1 max-w-xs">
                    <h3 class="font-bold text-md mb-1">${community.Name || 'N/A'}</h3>
                    <p class="text-xs mb-0.5">Sport: ${community.Sport || 'N/A'}</p>
                    <p class="text-xs mb-0.5">Cost: ${getCostDisplayText(community.Cost)}</p>
                    <p class="text-xs mb-0.5">Student: ${community['Student-based'] === 'Yes' ? 'Yes' : (community['Student-based'] === 'No' ? 'No' : 'N/A')}</p>
                    <p class="text-xs mb-0.5">Location: ${community.Location || 'N/A'}</p>
                    ${community.website ? `<p class="text-xs"><a href="${community.website}" target="_blank" class="text-orange-600 hover:text-orange-700 font-semibold">Visit Website</a></p>` : ''}
                </div>
            `);
            markerClusterGroup.addLayer(marker);
        } else {
            console.warn(`Geocoding failed for address: ${address}. No results. Response:`, data);
        }
    } catch (error) {
        console.error(`Error geocoding address '${address}':`, error);
    }
}

function handleSearch() { applyFilters(); }
function handleFilter() { applyFilters(); }

function applyFilters() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const costFilterValue = document.getElementById('costFilter').value; // "all", "Free", "Paid", "NA"
    const studentFilterValue = document.getElementById('studentFilter').value; // "all", "Yes", "No"
    const sportFilterValue = document.getElementById('sportFilter').value; // "all", or specific sport

    filteredCommunities = communities.filter(community => {
        const name = (community.Name || '').toLowerCase();
        const sport = (community.Sport || '').toLowerCase();
        const location = (community.Location || '').toLowerCase();
        
        const matchesSearch = !searchTerm || 
            name.includes(searchTerm) ||
            sport.includes(searchTerm) ||
            location.includes(searchTerm);

        let communityCostNormalized = String(community.Cost).toLowerCase();
        if (communityCostNormalized === "0") communityCostNormalized = "free";

        const matchesCost = costFilterValue === "all" ||
            (costFilterValue === "Free" && communityCostNormalized === "free") ||
            (costFilterValue === "Paid" && communityCostNormalized !== "free" && communityCostNormalized !== "na") ||
            (costFilterValue === "NA" && communityCostNormalized === "na");
        
        const communityStudentBased = community['Student-based'] || ''; // "Yes", "No", ""
        const matchesStudent = studentFilterValue === "all" || communityStudentBased === studentFilterValue;
        
        const communitySport = community.Sport || '';
        const matchesSport = sportFilterValue === "all" || communitySport.toLowerCase().includes(sportFilterValue.toLowerCase());

        return matchesSearch && matchesCost && matchesStudent && matchesSport;
    });

    renderCommunities();
    if (isMapVisible && map) { // Ensure map is initialized
        updateMapMarkers();
    }
}

function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('costFilter').value = 'all';
    document.getElementById('studentFilter').value = 'all';
    document.getElementById('sportFilter').value = 'all';
    
    filteredCommunities = [...communities];
    renderCommunities();
    if (isMapVisible && map) {
        updateMapMarkers();
    }
}

function renderCommunities() {
    const grid = document.getElementById('communitiesGrid');
    const noResultsEl = document.getElementById('noResults');
    const communitiesCountEl = document.getElementById('communitiesCount');

    communitiesCountEl.textContent = `Communities (${filteredCommunities.length})`;

    if (filteredCommunities.length === 0) {
        grid.innerHTML = '';
        grid.classList.add('hidden'); // Hide grid if it was visible
        noResultsEl.classList.remove('hidden');
        return;
    }

    noResultsEl.classList.add('hidden');
    grid.classList.remove('hidden'); // Show grid
    
    const cardClasses = isMapVisible ? "text-sm" : ""; // For elements inside the card that might change size

    grid.innerHTML = filteredCommunities.map(community => {
        const communityName = community.Name || 'Unnamed Community';
        const currentCostBadgeColor = getCostBadgeColor(community.Cost);
        const currentCostDisplayText = getCostDisplayText(community.Cost);

        // Placeholder for image
        const imagePlaceholderSvg = `
        <div class="absolute inset-0 flex w-full h-full items-center justify-center bg-gradient-to-br from-orange-100 to-red-100">
            <div class="text-center text-orange-700 p-4">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-12 w-12 mx-auto mb-2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                <p class="text-sm font-medium">${communityName}</p>
            </div>
        </div>`;

        const imageSectionClass = isMapVisible ? "aspect-[4/3]" : "aspect-video";
        const contentPaddingClass = isMapVisible ? "p-4" : "p-6";
        const titleClass = isMapVisible ? "text-base" : "text-lg";
        const detailsMbClass = isMapVisible ? "mb-3" : "mb-4";
        const iconSizeClass = isMapVisible ? "h-3 w-3" : "h-4 w-4";
        const sportIconOuter = isMapVisible ? "w-3 h-3" : "w-4 h-4";
        const sportIconInner = isMapVisible ? "text-[10px]" : "text-xs";
        const actionButtonHeightClass = isMapVisible ? "h-8 px-3 py-1" : "h-9 px-4 py-2";


        return `
        <div class="group bg-white rounded-2xl shadow-sm hover:shadow-xl transition-all duration-300 border border-orange-100 hover:border-orange-300 overflow-hidden flex flex-col ${cardClasses}">
            <div class="${imageSectionClass} bg-gradient-to-br from-orange-100 to-red-100 relative overflow-hidden">
                ${community.image_url ? `
                    <img 
                        src="${community.image_url}" 
                        alt="${communityName}"
                        class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                        onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                    />
                    <div style="display:none;">${imagePlaceholderSvg}</div>
                ` : imagePlaceholderSvg}
                <div class="absolute top-2 right-2">
                    <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium border ${currentCostBadgeColor}">
                        ${currentCostDisplayText}
                    </span>
                </div>
            </div>
            <div class="${contentPaddingClass} flex flex-col flex-grow">
                <h3 class="${titleClass} font-semibold text-orange-700 group-hover:text-orange-600 transition-colors mb-3">
                    ${communityName}
                </h3>
                <div class="space-y-3 ${detailsMbClass} flex-grow">
                    <div class="flex items-center gap-2 text-sm text-gray-600">
                        <div class="${sportIconOuter} bg-orange-500 rounded-full flex items-center justify-center">
                           <span class="${sportIconInner} text-white font-bold">S</span>
                        </div>
                        <span>${community.Sport || 'N/A'}</span>
                    </div>
                    <div class="flex items-center gap-2 text-sm text-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${iconSizeClass} text-orange-500"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                        <span>${community.Location || 'N/A'}</span>
                    </div>
                    <div class="flex items-center gap-2 text-sm text-gray-600">
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${iconSizeClass} text-orange-500"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                        <span>${community['Student-based'] === 'Yes' ? 'Student-focused' : (community['Student-based'] === 'No' ? 'Open to all' : 'N/A')}</span>
                    </div>
                </div>
                <div class="flex gap-2 mt-auto">
                    ${community.website ? `
                        <a href="${community.website}" target="_blank" rel="noopener noreferrer" class="flex-1 inline-flex items-center justify-center rounded-lg text-sm font-medium bg-orange-500 hover:bg-orange-600 text-white ${actionButtonHeightClass} transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4 mr-1"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" x2="21" y1="14" y2="3"></line></svg>
                            Website
                        </a>` : '<div class="flex-1"></div>'}
                    ${community.email ? `
                        <a href="mailto:${community.email}" class="flex-1 inline-flex items-center justify-center rounded-lg text-sm font-medium border border-orange-300 bg-white hover:bg-orange-50 text-orange-700 ${actionButtonHeightClass} transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4 mr-1"><rect width="20" height="16" x="2" y="4" rx="2"></rect><path d="m22 7-10 5L2 7"></path></svg>
                            Contact
                        </a>` : '<div class="flex-1"></div>'}
                </div>
            </div>
        </div>
    `}).join('');
}

function showLoadingState() {
    document.getElementById('loadingState').classList.remove('hidden');
    document.getElementById('communitiesGrid').classList.add('hidden');
    document.getElementById('noResults').classList.add('hidden');
}
function hideLoadingState() {
    document.getElementById('loadingState').classList.add('hidden');
    // communitiesGrid and noResults visibility handled by renderCommunities
}
function showNoResults() {
    hideLoadingState(); // Ensure loading is hidden
    document.getElementById('noResults').classList.remove('hidden');
    document.getElementById('communitiesGrid').classList.add('hidden'); // Ensure grid is hidden
    document.getElementById('communitiesGrid').innerHTML = '';
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => { clearTimeout(timeout); func(...args); };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}
</script>
{% endblock %}