{% extends "base.html" %}
{% block content %}
<main class="flex-1">
    <!-- Hero Section -->
    <section class="w-full py-12 md:py-24 lg:py-32 bg-gradient-to-b from-blue-50 to-blue-100/50">
        <div class="container mx-auto px-4 md:px-6">
            <div class="flex flex-col items-center text-center space-y-4 mb-8">
                <div class="space-y-2">
                    <div class="inline-block rounded-lg bg-blue-100 px-3 py-1 text-sm text-blue-600 font-medium mb-2">
                        FitBrain Game
                    </div>
                    <h1 class="text-3xl font-bold tracking-tighter sm:text-4xl md:text-5xl">Fit Quest</h1>
                    <p class="max-w-[800px] text-gray-500 md:text-xl">
                        Take a step towards stressilience.
                    </p>
                </div>
            </div>
        </div>
    </section>

    <!-- Game Content -->
    <section class="w-full py-12 md:py-24 bg-white">
        <div class="container mx-auto px-4 md:px-6">
            <!-- Flash Messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    <div class="mb-6">
                        {% for category, message in messages %}
                            <div class="{{ 'bg-red-100 border-red-400 text-red-700' if category == 'error' else 'bg-green-100 border-green-400 text-green-700' }} px-4 py-3 rounded relative border mb-2" role="alert">
                                <span class="block sm:inline">{{ message }}</span>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            {% endwith %}
            
    <!-- Navigation Tabs with Alpine.js -->
    <div x-data="{ activeTab: '{{ section }}', loadContent: function(tab) { this.activeTab = tab; } }">
        <nav class="flex space-x-4 mb-8 border-b border-gray-200">
            {% if current_user.is_authenticated %}
            <button @click="loadContent('progress')"
               class="px-3 py-2 text-sm font-medium rounded-md"
               :class="{'text-primary border-b-2 border-primary': activeTab === 'progress', 'text-gray-500 hover:text-gray-700': activeTab !== 'progress'}">My Progress</button>
            <button @click="loadContent('challenges')"
               class="px-3 py-2 text-sm font-medium rounded-md"
               :class="{'text-primary border-b-2 border-primary': activeTab === 'challenges', 'text-gray-500 hover:text-gray-700': activeTab !== 'challenges'}">Challenges</button>
            {% endif %}
            <button @click="loadContent('leaderboard')"
               class="px-3 py-2 text-sm font-medium rounded-md"
               :class="{'text-primary border-b-2 border-primary': activeTab === 'leaderboard', 'text-gray-500 hover:text-gray-700': activeTab !== 'leaderboard'}">Leaderboard</button>
            {% if current_user.is_authenticated %}
            <button @click="loadContent('profile')"
               class="px-3 py-2 text-sm font-medium rounded-md"
               :class="{'text-primary border-b-2 border-primary': activeTab === 'profile', 'text-gray-500 hover:text-gray-700': activeTab !== 'profile'}">Profile</button>
            {% else %}
            <button @click="loadContent('auth')"
               class="px-3 py-2 text-sm font-medium rounded-md"
               :class="{'text-primary border-b-2 border-primary': activeTab === 'auth', 'text-gray-500 hover:text-gray-700': activeTab !== 'auth'}">Login/Signup</button>
            {% endif %}
        </nav>

    <!-- Content Sections -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Main Content Area -->
        <div class="lg:col-span-2">
            <!-- Auth Section -->
            <div x-show="activeTab === 'auth' && {{ 'true' if not current_user.is_authenticated else 'false' }}" x-transition>
                {% if not current_user.is_authenticated %}
                    {% include 'game/auth.html' %}
                {% endif %}
            </div>
            
            <!-- Progress Section -->
            <div x-show="activeTab === 'progress' && {{ 'true' if current_user.is_authenticated else 'false' }}" x-transition>
                {% if current_user.is_authenticated %}
                    {% include 'game/progress.html' %}
                {% endif %}
            </div>
            
            <!-- Challenges Section -->
            <div x-show="activeTab === 'challenges' && {{ 'true' if current_user.is_authenticated else 'false' }}" x-transition>
                {% if current_user.is_authenticated %}
                    {% include 'game/challenges.html' %}
                {% endif %}
            </div>
            
            <!-- Profile Section -->
            <div x-show="activeTab === 'profile' && {{ 'true' if current_user.is_authenticated else 'false' }}" x-transition>
                {% if current_user.is_authenticated %}
                    {% include 'game/profile.html' %}
                {% endif %}
            </div>
            
            <!-- Leaderboard Section -->
            <div x-show="activeTab === 'leaderboard'" x-transition>
                {% include 'game/leaderboard.html' %}
            </div>
        </div>

        <!-- Sidebar -->
        <div class="lg:col-span-1">
            {% if current_user.is_authenticated %}
                <!-- User Stats Card -->
                <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                    <h3 class="text-lg font-semibold mb-4">Your Stats</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Total Points</span>
                            <span class="font-medium">{{ user_progress.total_points }}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Daily Streak</span>
                            <span class="font-medium">{{ user_progress.daily_streak }} days</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Rank</span>
                            <span class="font-medium">#{{ user_progress.rank|default(1) }}</span>
                        </div>
                    </div>
                </div>
                
                <!-- Weekly Habit Challenge Card -->
                {% set habit_challenge = current_user.get_weekly_habit_challenge() %}
                {% if habit_challenge %}
                <div class="bg-white rounded-lg shadow-sm p-6 mb-6 border-l-4 border-green-500">
                    <h3 class="text-lg font-semibold mb-2">Weekly Habit Challenge</h3>
                    <div class="mb-3">
                        <h4 class="font-medium text-primary">{{ habit_challenge.challenge.title }}</h4>
                        <p class="text-sm text-gray-600 mt-1">{{ habit_challenge.challenge.description }}</p>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div class="mb-2">
                        <div class="flex justify-between text-xs text-gray-600 mb-1">
                            <span>Progress: {{ habit_challenge.days_completed }}/7 days</span>
                            <span>
                                {% if habit_challenge.days_completed >= 4 %}
                                    {% if habit_challenge.days_completed == 7 %}
                                        +{{ habit_challenge.challenge.points }} bonus points
                                    {% else %}
                                        +{{ (habit_challenge.challenge.points * 0.5)|int }} bonus points
                                    {% endif %}
                                {% else %}
                                    Complete 4 days for bonus points
                                {% endif %}
                            </span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full" style="height: 0.625rem;">
                            <div class="bg-green-600 rounded-full" style="height: 0.625rem; width: {{ (habit_challenge.days_completed / 7 * 100)|int }}%;"></div>
                        </div>
                    </div>
                    
                    <!-- Day Indicators -->
                    <div class="flex justify-between mb-3">
                        {% for day in range(1, 8) %}
                        <div class="w-8 h-8 rounded-full flex items-center justify-center {{ 'bg-green-100 text-green-800' if day <= habit_challenge.days_completed else 'bg-gray-100 text-gray-400' }}">
                            {{ day }}
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Complete Today Button (if not already completed today) -->
                    <form action="/api/challenges/{{ habit_challenge.challenge_id }}/complete" method="POST" class="mt-2">
                        <button type="submit" class="w-full px-4 py-2 bg-primary text-white text-sm font-medium rounded-md hover:bg-primary-dark transition-colors">
                            Complete Today
                        </button>
                    </form>
                </div>
                {% endif %}
            {% endif %}

            <!-- In Progress Challenges -->
            {% if current_user.is_authenticated %}
                {% if challenges.in_progress %}
                <div class="bg-white rounded-lg shadow-sm p-6 border-l-4 border-primary">
                    <h3 class="text-lg font-semibold mb-4">In Progress Challenges ({{ challenges.in_progress|length }}/2)</h3>
                    {% for challenge in challenges.in_progress %}
                        <div class="space-y-3 {% if not loop.last %}mb-4 pb-4 border-b border-gray-100{% endif %}">
                            <h4 class="font-medium">{{ challenge.title }}</h4>
                            <p class="text-sm text-gray-600">{{ challenge.description }}</p>
                            <div class="flex justify-between items-center">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {{ 'bg-green-100 text-green-800' if challenge.difficulty == 'E' else 'bg-yellow-100 text-yellow-800' if challenge.difficulty == 'M' else 'bg-red-100 text-red-800' }}">
                                    {{ challenge.difficulty }} · {{ challenge.points }} points
                                </span>
                                <div class="space-x-2">
                                    <form action="/api/challenges/{{ challenge.id }}/complete" method="POST" style="display: inline;">
                                        <button type="submit" class="px-3 py-1 bg-primary text-white text-sm font-medium rounded hover:bg-primary-dark transition-colors">
                                            Complete
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                    {% if challenges.in_progress|length < 2 %}
                        <div class="mt-4 text-center">
                            <a href="/game/challenges" class="text-primary hover:text-primary-dark text-sm font-medium">
                                Find more challenges
                            </a>
                        </div>
                    {% endif %}
                </div>
                {% else %}
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h3 class="text-lg font-semibold mb-4">No Active Challenges</h3>
                    <p class="text-gray-600 mb-4">You don't have any challenges in progress.</p>
                    <a href="/game/challenges" class="px-4 py-2 bg-primary text-white text-sm font-medium rounded-md hover:bg-primary-dark transition-colors inline-block">
                        Find Challenges
                    </a>
                </div>
                {% endif %}
            {% else %}
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h3 class="text-lg font-semibold mb-4">Recent Activity</h3>
                    {% if recent_completed_challenges %}
                        <div class="space-y-4">
                            {% for completed, challenge, user in recent_completed_challenges %}
                                <div class="border-b border-gray-100 pb-3 last:border-0 last:pb-0">
                                    <div class="flex items-start justify-between">
                                        <div>
                                            <h4 class="font-medium text-sm">{{ challenge.title }}</h4>
                                            <p class="text-xs text-gray-500">Completed by {{ user.username }}</p>
                                        </div>
                                        <span class="text-xs font-medium px-2 py-1 bg-green-100 text-green-800 rounded-full">+{{ challenge.points }}</span>
                                    </div>
                                    <p class="text-xs text-gray-400 mt-1">{{ completed.completed_at.strftime('%b %d, %Y') }}</p>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-gray-600">No challenges have been completed yet.</p>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
</div>
</section>

<!-- Weekly Habit Challenge Selection Modal -->
{% if show_habit_modal %}
<div id="habitChallengeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" x-data="{ open: true }" x-show="open">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 overflow-hidden" @click.away="open = false">
        <div class="bg-primary text-white px-6 py-4">
            <h3 class="text-lg font-semibold">Make Your Favorite Challenge a Habit</h3>
            <p class="text-sm opacity-90">Complete it daily to earn bonus points!</p>
        </div>
        
        <div class="p-6">
            <p class="mb-4">Select one of your completed challenges from last week to make it your weekly habit challenge:</p>
            
            <form action="/api/habit-challenge/select" method="POST">
                <div class="space-y-3 mb-6 max-h-60 overflow-y-auto">
                    {% for user_challenge, challenge in current_user.get_previous_week_completed_challenges() %}
                    <label class="block p-3 border rounded-lg hover:border-primary cursor-pointer transition-colors">
                        <div class="flex items-start">
                            <input type="radio" name="challenge_id" value="{{ challenge.id }}" class="mt-1 mr-3">
                            <div>
                                <h4 class="font-medium">{{ challenge.title }}</h4>
                                <p class="text-sm text-gray-600">{{ challenge.description }}</p>
                                <div class="flex items-center mt-1">
                                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium {{ 'bg-green-100 text-green-800' if challenge.difficulty == 'E' else 'bg-yellow-100 text-yellow-800' }}">
                                        {{ challenge.difficulty }} · {{ challenge.points }} points
                                    </span>
                                    <span class="text-xs text-gray-500 ml-2">
                                        Completed on {{ user_challenge.completed_at.strftime('%b %d, %Y') }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </label>
                    {% endfor %}
                </div>
                
                <div class="bg-gray-50 -mx-6 -mb-6 px-6 py-4 flex justify-between">
                    <button type="button" class="px-4 py-2 text-gray-600 font-medium rounded-md hover:bg-gray-200 transition-colors" @click="open = false">
                        Skip for Now
                    </button>
                    <button type="submit" class="px-4 py-2 bg-primary text-white font-medium rounded-md hover:bg-primary-dark transition-colors">
                        Make it a Habit
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
</main>
{% endblock content %}

<!-- JavaScript for handling challenge interactions -->
{% block scripts %}
<script>
function startChallenge(challengeId) {
    fetch(`/api/challenges/${challengeId}/start`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = `/game/challenges?active=${challengeId}`;
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while starting the challenge.');
    });
}

// Function to update all countdown timers on the page - only updates when minutes change
function updateCountdownTimers() {
    // Get all timer elements in the challenges section
    const timerElements = document.querySelectorAll('.text-lg.font-bold.text-primary[data-regenerate-at]');
    if (timerElements.length === 0) return; // No timers to update
    
    // Current time in UTC
    const now = new Date();
    
    // Track if any timer needs a refresh (we'll only refresh once at the end)
    let needsRefresh = false;
    
    timerElements.forEach(timerElement => {
        // Get the regeneration timestamp from the data attribute
        const regenerateAtStr = timerElement.getAttribute('data-regenerate-at');
        if (!regenerateAtStr) return;
        
        // Parse the regeneration timestamp
        const regenerateAt = new Date(regenerateAtStr);
        
        // Calculate the time difference in seconds
        const timeDiffSeconds = Math.max(0, Math.floor((regenerateAt - now) / 1000));
        
        // If timer has expired, mark for refresh but don't refresh immediately
        if (timeDiffSeconds <= 0) {
            needsRefresh = true;
            return;
        }
        
        // Calculate hours, minutes, seconds
        const hours = Math.floor(timeDiffSeconds / 3600);
        const minutes = Math.floor((timeDiffSeconds % 3600) / 60);
        
        // Format the time string - only showing hours and minutes (not seconds)
        let newTimeText = '';
        if (hours > 0) {
            newTimeText = `${hours}h ${minutes}m`;
        } else {
            newTimeText = `${minutes}m`;
        }
        
        // Only update if the displayed text is different (avoid constant DOM updates)
        if (timerElement.textContent !== newTimeText) {
            timerElement.textContent = newTimeText;
        }
    });
    
    // Only refresh the page once every 30 seconds if timers have expired
    if (needsRefresh) {
        // Use localStorage to prevent constant refreshing
        const lastRefresh = localStorage.getItem('lastTimerRefresh');
        const now = new Date().getTime();
        
        if (!lastRefresh || (now - parseInt(lastRefresh)) > 30000) { // 30 seconds
            localStorage.setItem('lastTimerRefresh', now);
            window.location.reload();
        }
    }
}

// Update timers every second if there are any timers on the page
const timerElements = document.querySelectorAll('.text-lg.font-bold.text-primary[data-regenerate-at]');
if (timerElements.length > 0) {
    // Initial update
    updateCountdownTimers();
    
    // Set interval to update every second
    setInterval(updateCountdownTimers, 1000);
}

document.addEventListener('DOMContentLoaded', function() {
    // Update countdown timers immediately and then every second
    updateCountdownTimers();
    setInterval(updateCountdownTimers, 1000);
    
    // Check for success messages that indicate challenge completion
    const successMessages = document.querySelectorAll('.bg-green-100.border-green-400.text-green-700');
    for (const message of successMessages) {
        if (message.textContent.trim().includes('Challenge completed successfully') || 
            message.textContent.trim().includes('Habit challenge completed')) {
            launchConfetti();
            break;
        }
    }
});

// Function that launches confetti animation
function launchConfetti() {
    var duration = 3 * 1000;
    var end = Date.now() + duration;

    (function frame() {
        confetti({
            particleCount: 5,
            angle: 90,
            spread: 70,
            origin: { y: 0 },
            colors: ['#ff6b6b', '#feca57', '#1dd1a1', '#54a0ff', '#5f27cd'],
        });
        if (Date.now() < end) {
            requestAnimationFrame(frame);
        }
    })();
}
</script>
{% endblock scripts %}
